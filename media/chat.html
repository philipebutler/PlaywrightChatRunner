<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}';">
  <title>Playwright Chat Runner</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background: var(--vscode-sideBar-background, var(--vscode-editor-background));
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #toolbar {
      display: flex;
      gap: 6px;
      padding: 6px 8px;
      background: var(--vscode-sideBarSectionHeader-background);
      border-bottom: 1px solid var(--vscode-panel-border);
      flex-wrap: wrap;
    }

    #toolbar button {
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      border: 1px solid var(--vscode-button-border, transparent);
      padding: 3px 8px;
      cursor: pointer;
      font-size: 11px;
      border-radius: 2px;
    }

    #toolbar button:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    #tools-panel {
      padding: 6px 8px;
      background: var(--vscode-sideBarSectionHeader-background);
      border-bottom: 1px solid var(--vscode-panel-border);
      font-size: 11px;
    }

    #tools-panel summary {
      cursor: pointer;
      color: var(--vscode-foreground);
      font-weight: bold;
      user-select: none;
    }

    #tools-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 8px;
      margin-top: 6px;
    }

    #tools-grid label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #tools-grid input[type="checkbox"] {
      accent-color: var(--vscode-checkbox-background);
    }

    #transcript {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message {
      max-width: 90%;
      padding: 6px 10px;
      border-radius: 6px;
      word-break: break-word;
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.5;
    }

    .message.user {
      align-self: flex-end;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .message.llm {
      align-self: flex-start;
      background: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border, var(--vscode-panel-border));
      color: var(--vscode-foreground);
    }

    .message.error {
      align-self: flex-start;
      background: var(--vscode-inputValidation-errorBackground);
      border: 1px solid var(--vscode-inputValidation-errorBorder);
      color: var(--vscode-errorForeground, #f44);
    }

    .message.loaded-file {
      align-self: flex-start;
      background: var(--vscode-textBlockQuote-background);
      border-left: 3px solid var(--vscode-textBlockQuote-border);
      color: var(--vscode-foreground);
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      max-height: 120px;
      overflow-y: auto;
    }

    .result-block {
      align-self: flex-start;
      background: var(--vscode-textCodeBlock-background, var(--vscode-input-background));
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 6px 10px;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      max-width: 95%;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .result-block .result-header {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .result-block.success .result-header {
      color: var(--vscode-terminal-ansiGreen, #0a0);
    }

    .result-block.failure .result-header {
      color: var(--vscode-errorForeground, #f44);
    }

    #input-area {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 8px;
      border-top: 1px solid var(--vscode-panel-border);
      background: var(--vscode-sideBar-background, var(--vscode-editor-background));
    }

    #user-input {
      width: 100%;
      resize: vertical;
      min-height: 52px;
      max-height: 150px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border, var(--vscode-panel-border));
      padding: 4px 6px;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      border-radius: 2px;
    }

    #user-input:focus {
      outline: 1px solid var(--vscode-focusBorder);
      border-color: var(--vscode-focusBorder);
    }

    #send-btn {
      align-self: flex-end;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      padding: 4px 14px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 2px;
    }

    #send-btn:hover {
      background: var(--vscode-button-hoverBackground);
    }

    #send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="load-btn">ðŸ“‚ Load Instructions (.txt)</button>
    <button id="export-btn">ðŸ’¾ Export Results</button>
  </div>

  <details id="tools-panel">
    <summary>ðŸ”§ Enabled Tools (none = all)</summary>
    <div id="tools-grid">
      <label><input type="checkbox" value="goto"> goto</label>
      <label><input type="checkbox" value="clickText"> clickText</label>
      <label><input type="checkbox" value="type"> type</label>
      <label><input type="checkbox" value="waitForText"> waitForText</label>
      <label><input type="checkbox" value="extractText"> extractText</label>
      <label><input type="checkbox" value="snapshotText"> snapshotText</label>
      <label><input type="checkbox" value="screenshot"> screenshot</label>
      <label><input type="checkbox" value="closeBrowser"> closeBrowser</label>
    </div>
  </details>

  <div id="transcript"></div>

  <div id="input-area">
    <textarea id="user-input" placeholder="Describe what you want Playwright to doâ€¦ (Ctrl+Enter to send)"></textarea>
    <button id="send-btn">Send</button>
  </div>

  <script nonce="${nonce}">
    const vscode = acquireVsCodeApi();
    const transcript = document.getElementById('transcript');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const loadBtn = document.getElementById('load-btn');
    const exportBtn = document.getElementById('export-btn');
    const toolCheckboxes = document.querySelectorAll('#tools-grid input[type="checkbox"]');

    function appendMessage(cls, text) {
      const div = document.createElement('div');
      div.className = 'message ' + cls;
      div.textContent = text;
      transcript.appendChild(div);
      transcript.scrollTop = transcript.scrollHeight;
    }

    function appendResult(result) {
      const div = document.createElement('div');
      div.className = 'result-block ' + (result.success ? 'success' : 'failure');

      const header = document.createElement('div');
      header.className = 'result-header';
      header.textContent = (result.success ? 'âœ“ ' : 'âœ— ') + result.action;
      div.appendChild(header);

      if (result.data) {
        const data = document.createElement('div');
        data.textContent = result.data;
        div.appendChild(data);
      }
      if (result.error) {
        const err = document.createElement('div');
        err.style.color = 'var(--vscode-errorForeground, #f44)';
        err.textContent = 'Error: ' + result.error;
        div.appendChild(err);
      }

      transcript.appendChild(div);
      transcript.scrollTop = transcript.scrollHeight;
    }

    function sendEnabled() {
      const checked = [...toolCheckboxes].filter(c => c.checked).map(c => c.value);
      vscode.postMessage({ type: 'updateTools', enabledTools: checked });
    }

    toolCheckboxes.forEach(cb => cb.addEventListener('change', sendEnabled));

    sendBtn.addEventListener('click', () => {
      const text = userInput.value.trim();
      if (!text) return;
      vscode.postMessage({ type: 'submit', text });
      userInput.value = '';
    });

    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    loadBtn.addEventListener('click', () => {
      vscode.postMessage({ type: 'loadFile' });
    });

    exportBtn.addEventListener('click', () => {
      vscode.postMessage({ type: 'exportResults' });
    });

    window.addEventListener('message', (event) => {
      const msg = event.data;
      switch (msg.type) {
        case 'userMessage':
          appendMessage('user', msg.text);
          break;
        case 'llmMessage':
          appendMessage('llm', msg.text);
          break;
        case 'executionResult':
          appendResult(msg.result);
          break;
        case 'loadedFile':
          appendMessage('loaded-file', 'ðŸ“„ Loaded file:\n' + msg.text);
          break;
        case 'error':
          appendMessage('error', 'âš  ' + msg.text);
          break;
      }
    });
  </script>
</body>
</html>
